profiles {
    standard {
        process.executor = 'slurm'
        process.queue = 'earth-5'
        process.clusterOptions = '--account=lsfm-edu-icls-grp-default'
        executor.queueSize = 2
        executor.submitRateLimit = '10 sec'
    }
    
    local {
        process.executor = 'local'
        process.cpus = 4
        process.memory = '128 GB'
        executor.cpus = 32
        executor.memory = '189 GB'
    }
}

// Enable performance tracking
trace {
    enabled = true
    file = 'trace.txt'
    fields = 'task_id,hash,native_id,name,status,exit,module,container,cpus,memory,duration,realtime,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,submit,start,complete'
    raw = true
}

timeline {
    enabled = true
    file = 'timeline.html'
}

report {
    enabled = true
    file = 'report.html'
}

// Enhanced monitoring
dag {
    enabled = false
    file = 'dag.svg'
}

// Default parameters
params {
    // Input/Output
    fastq_dir = "/cfs/earth/scratch/laglepia/Onex/Working/data_10x"
    output_dir = "/cfs/earth/scratch/laglepia/Onex/Working/nextflow_test/outputs"
    species = "mouse"  // or "human"

    // Reference files
    genome_dir = "/cfs/earth/scratch/laglepia/Onex/Working/genomeDir_mouse"
    whitelist = "/cfs/earth/scratch/laglepia/Onex/Working/3M-february-2018.txt"
    singler_ref = "/cfs/earth/scratch/laglepia/Onex/Working/nextflow_test/ref_mouse/mouse_rnaseq_ref.rds"
    nichenet_dir = "/cfs/earth/scratch/laglepia/Onex/Working/nextflow_test/ref_mouse/nichenet"
    
    // STARsolo parameters
    threads = 8
    // per-sample STAR threads (used by STARSOLO_SAMPLE)
    starsolo_threads = 8
    // maximum parallel STAR tasks to submit (increase for faster processing)
    max_parallel_stars = 4
    // barcode read length (0 = auto-detect, or specify exact length)
    soloBarcodeReadLength = 0
    
    // Single-cell specific STARsolo parameters
    soloUMIlen = 12          // UMI length (typically 10-12 for 10x)
    soloCBlen = 16           // Cell barcode length (typically 16 for 10x v2/v3)
    soloUMIstart = 17        // UMI start position (CB length + 1)
    soloMemoryLimit = 100000000000  // Memory limit for BAM sorting (100GB)
    
    // Conditions to process
    conditions = "auto"  // auto-detect all conditions, or specify comma-separated list
    
    // ===== QC & Integration Parameters (01_qc_integration.R) =====
    qc {
        random_seed = 42
        min_cells_per_gene = 3
        min_features_per_cell = 200
        quantile_low = 0.05
        quantile_high = 0.95
        n_variable_features = 3000
        top_hvg_label = 10
        top_hvg_dotplot = 10
        hvg_per_condition = 3000
        integration_dims = 30           // Number of dims for integration
        clustering_resolution = 0.5
        pca_npcs = 30
        umap_dims = 30
        tsne_dims = 30
    }
    
    // ===== Plotting Parameters (global for all R scripts) =====
    plotting {
        max_cells_interactive = 30000   // Max cells for interactive plots
        plot_width = 12
        plot_height = 6
        base_font_size = 18
        title_font_size = 24
        axis_title_size = 18
        axis_text_size = 18
        legend_size = 18
    }
    
    // ===== Clustering & Annotation Parameters (02_clustering_annotation.R) =====
    clustering {
        random_seed = 42
        pca_min_dims = 10               // Minimum PC to test
        pca_search_space = 50           // Maximum PCs to test (10-50 searchspace)
        jackstraw_enabled = true        // Set to false to skip JackStraw (faster)
        jackstraw_replicates = 50       // Increased from 25 for better precision
        jackstraw_cores = 16             // Increased cores for parallel processing
        marker_workers = 16
        marker_max_cells_per_cluster = null  // null = no downsampling
        k_neighbors = 20                // For MiloR compatibility
        max_cells_metrics = 5000
        top_loading_genes = 10
    }
    
    // ===== Differential Analysis Parameters (03_differential_analysis.R) =====
    differential {
        random_seed = 42
        base_size = 18
        title_size = 24
        axis_title_size = 18
        axis_text_size = 18
        legend_size = 18
        min_cells_pseudobulk = 10
        min_cells_cluster = 3
        log2fc_threshold = 0.25
        min_pct = 0.10
        fdr_threshold = 0.05
        top_genes_heatmap = 20
    }
    
    // Analysis parameters
    // JackStraw automatically determines optimal PCs from this search space
    pca_search_space = 50  // Number of PCs to test with JackStraw (will auto-select significant ones)

    // Clustering resolutions to test (automatic selection picks the best)
    resolutions = "0.1, 0.3, 0.5, 0.7, 0.8, 0.9, 1.1, 1.3"
    
    // Fallback parameters (only used if JackStraw fails)
    pc_dims = "1:50"        // Fallback PC dims range if JackStraw doesn't work
    umap_neighbors = 30

    // MiloR (Differential Abundance)
    // Note: 'd' (dimensions) is automatically set from JackStraw-optimized PCs
    // The value below is only used as fallback if analysis_parameters cannot be loaded
    milo {
        use_pca = true
        k = 10
        d = 30              // Fallback only - auto-uses JackStraw PCs from clustering
        prop = 0.1
        refined = true
        sample_field = "condition"
        fdr_threshold = 0.1
        fdr_weighting = "neighbour-distance"  // Options: "k-distance" (slowest, most accurate), "none" (fastest), "neighbour-distance"
    }

    // Seurat (Differential State / FindMarkers)
    seurat {
        findmarkers {
            test_use = "wilcox"
            logfc_threshold = 0.1
            min_pct = 0.1
            min_cells_per_cluster = 10
            plot_fdr = 0.05
            plot_logfc = 0.25
            top_n_genes = 5
        }
    }

    // muscat (Pseudobulk DS)
    muscat {
        aggregate_by = "cluster_id,sample_id"
        sample_id_pattern = "{group}_{cell_index}"
        contrast = [0, 1]
        fdr = 0.05
        logfc = 0.5
    }
    
    // Trajectory analysis parameters
    use_slingshot = true
    use_monocle3 = true

    // NMF Gene Program Discovery parameters
    nmf_min_rank = 2
    nmf_max_rank = 2
    
    // ===== Benchmarking Parameters (07_benchmarking.R) =====
    benchmarking {
        silhouette_subsample = 5000     // Max cells for silhouette calculation
        silhouette_threshold = 0.3      // Threshold for good integration (< 0.3)
    }
    
    // Checkpoint: start from specific step
    // Options: starsolo, qc, clustering, differential, cellcomm, geneprog, report
    start_from = "qc"
    
    // Help message
    help = false
}

// Resource defaults
process {
    withName: STARSOLO_SAMPLE {
        cpus = params.starsolo_threads
        memory = '120 GB'
        time = '12h'
        // limit concurrent STAR sample jobs
        maxForks = params.max_parallel_stars
    }
    
    withName: QC_INTEGRATION {
        cpus = 8
        memory = '128 GB'
        time = '8h'
    }
    
    withName: CLUSTERING_ANNOTATION {
        cpus = 8
        memory = '180 GB'
        time = '6h'
    }
    
    withName: DIFFERENTIAL_ANALYSIS {
        cpus = 8
        memory = '180 GB'
        time = '4h'
        maxForks = 2
    }
    
    withName: CELLCHAT_ANALYSIS {
        cpus = 8
        memory = '120 GB'
        time = '6h'
    }
    
    withName: NICHENET_ANALYSIS {
        cpus = 8
        memory = '80 GB'
        time = '4h'
    }
    
    withName: GENE_PROGRAM_DISCOVERY {
        cpus = 8
        memory = '180 GB'
        time = '12h'
    }
    
    withName: TRAJECTORY_ANALYSIS {
        cpus = 4
        memory = '120 GB'
        time = '4h'
    }
}

// Conda configuration
conda {
    enabled = true
    cacheDir = '/cfs/earth/scratch/laglepia/.conda/envs/'
    useMamba = false
    createOptions = '-c conda-forge -c bioconda'
}

// Conda environment paths (8 environments total)
params.conda_starsolo_env = '/cfs/earth/scratch/laglepia/.conda/envs/starsolo_env'                  // 00: STARsolo alignment
params.conda_seurat_env = '/cfs/earth/scratch/laglepia/.conda/envs/seurat_env_3_soupx'              // 01: QC & Integration (Seurat 4.3.0)
params.conda_annotation_env = '/cfs/earth/scratch/laglepia/.conda/envs/annotation_singler2'         // 02: Clustering & Annotation (SingleR)
params.conda_cellchat_v2 = '/cfs/earth/scratch/laglepia/.conda/envs/cellcomm2_env'                  // 04a: CellChat analysis
params.conda_cellcomm_multi = '/cfs/earth/scratch/laglepia/.conda/envs/cellcomm_env'                // 04b: NicheNet analysis
params.conda_nmf_env = '/cfs/earth/scratch/laglepia/.conda/envs/cellcomm_genenmf'                   // 05: Gene programs (GeneNMF)
params.conda_trajectory_env = '/cfs/earth/scratch/laglepia/.conda/envs/trajectory_analysis'         // 06: Trajectory inference (Slingshot)
params.conda_benchmarking_env = '/cfs/earth/scratch/laglepia/.conda/envs/benchmarking_env'          // 07: Benchmarking

// Ensure conda is initialized before process execution
process.beforeScript = '''
    source ~/.bashrc || true
    eval "$(conda shell.bash hook)" || true
'''

// Execution reporting - enabled to capture per-process resource usage
report.enabled = true
timeline.enabled = true
trace.enabled = true

report.file = "${params.output_dir}/08_reports/nextflow_report.html"
timeline.file = "${params.output_dir}/08_reports/nextflow_timeline.html"
trace.file = "${params.output_dir}/08_reports/nextflow_trace.txt"

// Allow overwriting report/trace/timeline files when re-running
// This prevents Nextflow failing if a previous run left these files behind.
report.overwrite = true
timeline.overwrite = true
trace.overwrite = true